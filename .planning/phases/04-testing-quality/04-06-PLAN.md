---
phase: 04-testing-quality
plan: 06
type: execute
wave: 4
depends_on: ["04-02", "04-03", "04-04", "04-05"]
files_modified:
  - .github/workflows/ci.yml
autonomous: true

must_haves:
  truths:
    - "Pull requests trigger automated lint, test, and build checks"
    - "CI fails if tests fail or coverage thresholds not met"
    - "Biome checks run on pull requests (QUAL-04)"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "GitHub Actions CI workflow"
      contains: "npm test"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "package.json"
      via: "npm scripts"
      pattern: "npm run"
---

<objective>
Create GitHub Actions CI workflow for automated testing on pull requests.

Purpose: CI gates ensure code quality - no untested or broken code reaches main.
Output: GitHub Actions workflow running lint, test, and build on PRs.
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create .github/workflows/ci.yml:

```yaml
name: CI

on:
  pull_request:
    branches: [master, main]
  push:
    branches: [master, main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Biome checks
        run: npm run lint

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests with coverage
        run: npm run test:coverage -- --run

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build extension
        run: npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-build
          path: .output/chrome-mv3/
          retention-days: 7

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Build extension
        run: npm run build

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
```

This workflow:
- Runs lint (Biome) on all PRs (QUAL-04)
- Runs unit tests with coverage thresholds
- Builds extension to verify build works
- Runs E2E tests after build
- Uploads artifacts for debugging
  </action>
  <verify>
`cat .github/workflows/ci.yml | grep -q "npm run lint"` confirms Biome check.
`cat .github/workflows/ci.yml | grep -q "npm run test:coverage"` confirms test job.
  </verify>
  <done>CI workflow created with lint, test, build, and E2E jobs.</done>
</task>

<task type="auto">
  <name>Task 2: Verify all tests pass locally</name>
  <files>(verification only)</files>
  <action>
Run the full test suite locally to verify everything works before CI:

1. Run lint: `npm run lint`
2. Run unit tests: `npm run test:coverage -- --run`
3. Run build: `npm run build`
4. Run E2E: `npm run test:e2e`

Fix any failures before committing CI workflow.

Check coverage output shows:
- Global coverage >=70%
- src/utils/ modules coverage >=90%
- entrypoints/background.ts coverage >=90%
  </action>
  <verify>
`npm run lint` exits 0.
`npm run test:coverage -- --run` exits 0 and shows coverage report.
`npm run build` exits 0.
`npm run test:e2e` exits 0.
  </verify>
  <done>All tests pass locally, ready for CI.</done>
</task>

<task type="auto">
  <name>Task 3: Add .gitignore entries for test artifacts</name>
  <files>.gitignore</files>
  <action>
Ensure test artifacts are gitignored:

Add to .gitignore if not present:
```
# Test coverage
coverage/

# Playwright
playwright-report/
test-results/
```

These directories are generated by test runs and should not be committed.
  </action>
  <verify>
`grep -q "coverage/" .gitignore` confirms coverage ignored.
`grep -q "playwright-report/" .gitignore` confirms Playwright report ignored.
  </verify>
  <done>Test artifacts added to .gitignore.</done>
</task>

</tasks>

<verification>
1. `.github/workflows/ci.yml` exists with lint, test, build, e2e jobs
2. All local tests pass: lint, unit tests, build, E2E
3. Coverage thresholds met (70% global, 90% business logic)
4. Test artifacts gitignored
</verification>

<success_criteria>
- [ ] CI workflow runs Biome lint on PRs (QUAL-04)
- [ ] CI workflow runs unit tests with coverage
- [ ] CI workflow runs build
- [ ] CI workflow runs E2E tests
- [ ] All tests pass locally
- [ ] Test artifacts gitignored
</success_criteria>

<output>
After completion, create `.planning/phases/04-testing-quality/04-06-SUMMARY.md`
</output>
