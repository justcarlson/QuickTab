---
phase: 04-testing-quality
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/utils/url-matching.test.ts
autonomous: true

must_haves:
  truths:
    - "All three URL matching functions have test coverage"
    - "Valid Zendesk URLs matched correctly by subdomain, path, and type"
    - "Restricted routes (chat, voice, print) return null"
    - "Invalid URLs and non-Zendesk domains return null"
  artifacts:
    - path: "src/utils/url-matching.test.ts"
      provides: "Unit tests for URL matching module"
      min_lines: 100
  key_links:
    - from: "src/utils/url-matching.test.ts"
      to: "src/utils/url-matching.ts"
      via: "import statements"
      pattern: "from.*url-matching"
---

<objective>
Create comprehensive unit tests for the URL matching module.

Purpose: URL matching is critical business logic - incorrect matching breaks the core extension behavior.
Output: Test file with 90%+ coverage of url-matching.ts functions.
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-testing-quality/04-RESEARCH.md
@src/utils/url-matching.ts
@src/utils/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create URL matching test file with comprehensive coverage</name>
  <files>src/utils/url-matching.test.ts</files>
  <action>
Create src/utils/url-matching.test.ts with tests for all three exported functions.

Test `matchZendeskUrl`:
1. Valid Zendesk URLs:
   - Agent ticket URLs: `https://company.zendesk.com/agent/tickets/123`
   - Lotus routes: `https://company.zendesk.com/agent/dashboard`
   - Various ticket route patterns: /tickets/, /requests/, /twickets/, /hc/requests/
   - Query params ignored: URL with ?foo=bar returns same path
   - Hash fragments ignored: URL with #section returns same path
2. Restricted routes (return null):
   - Chat: `/agent/chat`
   - Voice/Talk: `/agent/talk`
   - Voice admin: `/agent/admin/voice`
   - Print view: `/tickets/123/print`
3. Invalid URLs (return null):
   - Non-Zendesk domains
   - Root zendesk.com (no subdomain)
   - Malformed URLs (not-a-url)
   - Help center URLs (/hc/articles/)

Test `buildZendeskUrl`:
1. Constructs correct agent URL from RouteMatch
2. Handles both ticket and lotus types

Test `isZendeskAgentUrl`:
1. Returns true for agent URLs
2. Returns false for help center URLs
3. Returns false for malformed URLs
4. Returns false for non-Zendesk domains

Use describe blocks to organize test cases per RESEARCH.md code examples.
  </action>
  <verify>
`npm test -- --run src/utils/url-matching.test.ts` passes all tests.
`npm run test:coverage -- --run src/utils/url-matching.test.ts` shows >90% coverage for url-matching.ts.
  </verify>
  <done>URL matching tests pass with >90% coverage of the module.</done>
</task>

<task type="auto">
  <name>Task 2: Verify edge cases and coverage gaps</name>
  <files>src/utils/url-matching.test.ts</files>
  <action>
Review coverage report and add any missing test cases:

1. Run coverage: `npm run test:coverage -- --run src/utils/url-matching.test.ts`
2. Open coverage/index.html in browser
3. Check url-matching.ts for uncovered branches
4. Add tests for any uncovered code paths

Common gaps to check:
- The catch block in matchZendeskUrl (invalid URL)
- Empty subdomain check (root zendesk.com)
- The path normalization logic (.replace("#/", ""))
- The catch block in isZendeskAgentUrl

If coverage is already >90%, this task is a verification pass.
  </action>
  <verify>
`npm run test:coverage -- --run src/utils/url-matching.test.ts 2>&1 | grep url-matching` shows >90% on all metrics.
  </verify>
  <done>URL matching module has >90% coverage with all edge cases tested.</done>
</task>

</tasks>

<verification>
1. `npm test -- --run src/utils/url-matching.test.ts` passes
2. Coverage report shows >90% for src/utils/url-matching.ts
3. All three functions (matchZendeskUrl, buildZendeskUrl, isZendeskAgentUrl) have tests
4. Restricted routes correctly return null
</verification>

<success_criteria>
- [ ] matchZendeskUrl tested for valid URLs, restricted routes, and invalid URLs
- [ ] buildZendeskUrl tested for URL construction
- [ ] isZendeskAgentUrl tested for agent vs non-agent URLs
- [ ] Coverage >90% for url-matching.ts
- [ ] All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-testing-quality/04-02-SUMMARY.md`
</output>
