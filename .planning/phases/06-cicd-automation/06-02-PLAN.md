---
phase: 06-cicd-automation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/release.yml
  - CLAUDE.md
autonomous: true

must_haves:
  truths:
    - "Release workflow runs lint, test, build before publishing artifacts"
    - "Pre-release tags (v1.0.0-beta.1) create GitHub pre-releases"
    - "CLAUDE.md documents commit message conventions"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "Tag-triggered release workflow with CI gate"
      contains: "needs: [lint, test, build]"
    - path: "CLAUDE.md"
      provides: "Commit conventions for changelog-ready messages"
      contains: "Conventional Commits"
  key_links:
    - from: ".github/workflows/release.yml"
      to: "softprops/action-gh-release@v2"
      via: "release step"
      pattern: "softprops/action-gh-release@v2"
    - from: ".github/workflows/release.yml"
      to: "prerelease detection"
      via: "contains expression"
      pattern: "contains\\(github\\.ref, '-'\\)"
---

<objective>
Enhance release workflow with CI gate and add commit convention documentation.

Purpose: Ensure every release passes CI before publishing, automatically detect pre-releases, and document commit conventions for changelog-ready messages.

Output: Enhanced release.yml with lint/test/build jobs before release, and CLAUDE.md with conventional commit documentation.
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-cicd-automation/06-RESEARCH.md
@.github/workflows/release.yml
@.github/workflows/ci.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance release workflow with CI gate</name>
  <files>.github/workflows/release.yml</files>
  <action>
Rewrite release.yml to add CI jobs before the release job.

**Pre-condition:** .github/workflows/ci.yml exists (created in Phase 4, plan 04-06). Reference its job structure for consistency.

**Keep existing:**
- Trigger on push tags "v*"
- workflow_dispatch trigger
- permissions: contents: write

**Add CI jobs (mirror structure from ci.yml for consistency):**
1. **lint** job: checkout, setup-node@v4 (node 20), npm ci, npm run lint
2. **test** job: checkout, setup-node@v4 (node 20), npm ci, npm run test:coverage -- --run
3. **build** job: checkout, setup-node@v4 (node 20), npm ci, npm run build

**Modify release job:**
- Add `needs: [lint, test, build]` - release only runs after CI passes
- Keep existing steps: checkout, setup-node, npm ci, npm run build, npm run zip
- Modify softprops/action-gh-release@v2 step to add:
  - `prerelease: ${{ contains(github.ref, '-') }}` - detects pre-release versions
  - `generate_release_notes: false` - we use our own changelog

**Standardize Node version:** Use node 20 (matching ci.yml) not node 22.
  </action>
  <verify>
```bash
cat .github/workflows/release.yml | grep -E "(needs:|prerelease:|node-version)"
```
Should show: needs: [lint, test, build], prerelease: expression, node-version: '20'
  </verify>
  <done>Release job has needs: [lint, test, build], prerelease detection uses contains expression</done>
</task>

<task type="auto">
  <name>Task 2: Create CLAUDE.md with commit conventions</name>
  <files>CLAUDE.md</files>
  <action>
Create CLAUDE.md file at project root with commit convention documentation:

**Structure:**
1. "Commit Message Format" section
   - Reference Conventional Commits spec
   - Show format: `<type>(<scope>): <description>`

2. "Types and Changelog Mapping" table:
   | Type | Changelog Section | Version Bump |
   | feat | Added | minor |
   | fix | Fixed | patch |
   | refactor | Changed | patch |
   | perf | Changed | patch |
   | feat! / fix! | (breaking) | major |

3. "Writing Changelog-Ready Commits" section:
   - Description: What changed (imperative mood)
   - Body: Why it changed (context for future readers)
   - Breaking changes: Use `!` suffix AND `BREAKING CHANGE:` footer

4. "Examples" section with 3 examples:
   - Simple feat with body
   - Simple fix with body explaining context
   - Breaking change with ! suffix and footer

Keep it concise and actionable. No emojis.
  </action>
  <verify>
```bash
cat CLAUDE.md | head -30
```
Should show: Conventional Commits reference, type mapping table, examples.
  </verify>
  <done>CLAUDE.md exists with commit format, type mapping table, and examples</done>
</task>

</tasks>

<verification>
1. release.yml has four jobs: lint, test, build, release
2. release job has `needs: [lint, test, build]`
3. release job uses `prerelease: ${{ contains(github.ref, '-') }}`
4. CLAUDE.md exists with conventional commit documentation
5. Both files have valid YAML/markdown syntax
6. All Node versions are consistently set to 20 (matching ci.yml)
</verification>

<success_criteria>
- release.yml runs CI (lint, test, build) before release
- release.yml detects pre-release versions via hyphen in tag
- CLAUDE.md documents commit types and their changelog mapping
- All workflows use Node 20 consistently
</success_criteria>

<output>
After completion, create `.planning/phases/06-cicd-automation/06-02-SUMMARY.md`
</output>
