---
phase: 03-ui-migration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - entrypoints/popup/index.html
  - entrypoints/popup/main.ts
autonomous: true

must_haves:
  truths:
    - "Popup displays current detection mode from service worker"
    - "User can toggle between allUrls, ticketUrls, and noUrls modes"
    - "Mode change persists immediately without save button"
    - "All user-visible text uses i18n strings from messages.json"
  artifacts:
    - path: "entrypoints/popup/index.html"
      provides: "Popup HTML structure with mode radio options and help links"
      contains: "mode-option"
    - path: "entrypoints/popup/main.ts"
      provides: "Popup logic for state loading and mode changing"
      exports: []
  key_links:
    - from: "entrypoints/popup/main.ts"
      to: "entrypoints/background.ts"
      via: "chrome.runtime.sendMessage"
      pattern: "sendMessage.*getStatus|sendMessage.*setMode"
---

<objective>
Implement the popup UI with detection mode toggle and help section.

Purpose: Provide users a way to view and change the URL detection mode. The popup communicates with the background service worker via messaging.

Output: Functional popup with three-way mode toggle, help links, and i18n support.
</objective>

<execution_context>
@/home/jc/.claude/get-shit-done/workflows/execute-plan.md
@/home/jc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-ui-migration/03-CONTEXT.md
@.planning/phases/03-ui-migration/03-RESEARCH.md
@.planning/phases/03-ui-migration/03-01-SUMMARY.md
@entrypoints/background.ts
@public/_locales/en/messages.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create popup HTML structure</name>
  <files>entrypoints/popup/index.html</files>
  <action>
Replace the placeholder HTML with the full popup structure.

Structure:
```html
<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuickTab</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <div id="app" class="loading">
    <header>
      <h1>QuickTab</h1>
    </header>

    <section id="mode-section">
      <h2 id="mode-heading"></h2>
      <div class="mode-options" role="radiogroup" aria-labelledby="mode-heading">
        <label class="mode-option">
          <input type="radio" name="detection-mode" value="allUrls">
          <span class="indicator" aria-hidden="true"></span>
          <span class="label" id="label-allUrls"></span>
        </label>
        <label class="mode-option">
          <input type="radio" name="detection-mode" value="ticketUrls">
          <span class="indicator" aria-hidden="true"></span>
          <span class="label" id="label-ticketUrls"></span>
        </label>
        <label class="mode-option">
          <input type="radio" name="detection-mode" value="noUrls">
          <span class="indicator" aria-hidden="true"></span>
          <span class="label" id="label-noUrls"></span>
        </label>
      </div>
    </section>

    <section id="help-section">
      <h2 id="help-heading"></h2>
      <ul>
        <li>
          <a href="https://github.com/zendesklabs/QuickTab#readme"
             target="_blank"
             rel="noopener noreferrer"
             id="link-docs"></a>
        </li>
        <li>
          <a href="#" id="link-welcome"></a>
        </li>
      </ul>
    </section>
  </div>
  <script type="module" src="./main.ts"></script>
</body>
</html>
```

Key elements:
- #app with .loading class (removed after state loads)
- Radio group with role="radiogroup" for accessibility
- Each mode-option has: input[type=radio], .indicator span, .label span
- Help section with external docs link and welcome page link
- All text content elements have IDs for i18n population
  </action>
  <verify>
Run `npm run build` and verify HTML is valid.
Open popup.html in browser and verify structure renders.
  </verify>
  <done>
Popup HTML contains mode radio group, help links, and i18n placeholder elements.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement popup TypeScript logic</name>
  <files>entrypoints/popup/main.ts</files>
  <action>
Replace the placeholder with full popup logic.

Implementation:

```typescript
/**
 * QuickTab Popup
 *
 * Displays current detection mode and allows toggling between modes.
 * Communicates with background service worker via chrome.runtime.sendMessage.
 */

import type { UrlDetectionMode } from '@/src/utils/types';

interface GetStatusResponse {
  mode: UrlDetectionMode;
}

/**
 * Get localized string with fallback to key name.
 */
function t(key: string): string {
  return chrome.i18n.getMessage(key) || `[${key}]`;
}

/**
 * Request current mode from background service worker.
 */
async function getStatus(): Promise<UrlDetectionMode> {
  const response = await chrome.runtime.sendMessage({ type: 'getStatus' });
  return (response as GetStatusResponse).mode;
}

/**
 * Send mode change to background service worker.
 */
async function setMode(mode: UrlDetectionMode): Promise<void> {
  await chrome.runtime.sendMessage({ type: 'setMode', mode });
}

/**
 * Update radio button selection to match current mode.
 */
function updateModeUI(currentMode: UrlDetectionMode): void {
  const radios = document.querySelectorAll<HTMLInputElement>(
    'input[name="detection-mode"]'
  );
  radios.forEach(radio => {
    radio.checked = radio.value === currentMode;
  });
}

/**
 * Populate all i18n strings in the popup.
 */
function populateI18n(): void {
  // Section headings
  document.getElementById('mode-heading')!.textContent =
    t('txt_popup_title_link_detection');
  document.getElementById('help-heading')!.textContent =
    t('txt_popup_title_help');

  // Mode labels
  document.getElementById('label-allUrls')!.textContent =
    t('txt_popup_options_link_detection_allLinks');
  document.getElementById('label-ticketUrls')!.textContent =
    t('txt_popup_options_link_detection_ticketLinks');
  document.getElementById('label-noUrls')!.textContent =
    t('txt_popup_options_link_detection_noLinks');

  // Help links
  document.getElementById('link-docs')!.textContent =
    t('txt_popup_options_help_documentation');
  document.getElementById('link-welcome')!.textContent =
    t('txt_popup_options_help_welcome');
}

/**
 * Initialize popup on DOM ready.
 */
document.addEventListener('DOMContentLoaded', async () => {
  // Populate i18n strings first (while loading)
  populateI18n();

  try {
    // Load current mode from background
    const currentMode = await getStatus();
    updateModeUI(currentMode);
  } catch (error) {
    // Silent fallback - default to allUrls on error
    console.warn('QuickTab: Failed to get status', error);
    updateModeUI('allUrls');
  }

  // Remove loading state
  document.getElementById('app')!.classList.remove('loading');

  // Bind mode change handlers
  document.querySelectorAll<HTMLInputElement>('input[name="detection-mode"]')
    .forEach(radio => {
      radio.addEventListener('change', async () => {
        if (radio.checked) {
          try {
            await setMode(radio.value as UrlDetectionMode);
          } catch (error) {
            // Silent fallback - log but don't show error to user
            console.warn('QuickTab: Failed to set mode', error);
          }
        }
      });
    });

  // Bind welcome page link
  document.getElementById('link-welcome')!.addEventListener('click', (e) => {
    e.preventDefault();
    const welcomeUrl = chrome.runtime.getURL('welcome.html');
    chrome.tabs.create({ url: welcomeUrl });
  });
});
```

Key behaviors per CONTEXT.md:
- Instant toggle: mode changes apply immediately on click
- State change only: toggle moving is sufficient feedback
- Silent fallback: log error, keep last known state, no user-visible error
- Load state before showing UI to prevent flash of wrong state
  </action>
  <verify>
1. Run `npm run build` and verify no TypeScript errors
2. Load extension in Chrome and click popup icon
3. Verify mode options display with correct i18n text
4. Verify clicking a mode option changes the mode (check via DevTools storage)
5. Verify welcome link opens the welcome page in a new tab
6. Verify docs link opens GitHub README in new tab
  </verify>
  <done>
Popup loads current mode, allows toggling, and persists changes via background service worker.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Popup displays three mode options with localized labels
3. Current mode is pre-selected when popup opens
4. Clicking a different mode immediately updates selection
5. Mode change persists (reload extension, reopen popup shows new mode)
6. Help links work (docs opens GitHub, welcome opens welcome page)
7. Loading state disappears after mode loads
</verification>

<success_criteria>
- Popup displays current detection mode from service worker
- User can toggle between allUrls, ticketUrls, and noUrls modes
- Mode change persists immediately without save button
- All user-visible text uses i18n strings from messages.json
- Welcome link opens welcome.html in new tab
</success_criteria>

<output>
After completion, create `.planning/phases/03-ui-migration/03-02-SUMMARY.md`
</output>
