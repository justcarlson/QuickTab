var background=(function(){"use strict";function E(t){return t==null||typeof t=="function"?{main:t}:t}const S=globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome,u="quicktab_state",p={zendeskTabs:{}};async function h(){try{return(await chrome.storage.local.get(u))[u]??p}catch(t){return console.warn("QuickTab: Storage read failed, using default state",t),p}}async function i(t){try{await chrome.storage.local.set({[u]:t})}catch(e){console.warn("QuickTab: Storage write failed",e)}}async function l(){try{return(await chrome.storage.local.get("urlDetection")).urlDetection??"allUrls"}catch(t){return console.warn("QuickTab: Failed to read URL detection mode",t),"allUrls"}}async function z(t){try{await chrome.storage.local.set({urlDetection:t})}catch(e){console.warn("QuickTab: Failed to write URL detection mode",e)}}async function L(){try{await chrome.storage.local.remove(u)}catch(t){console.warn("QuickTab: Failed to clear state",t)}}async function _(t){try{const e=await chrome.tabs.get(t);return await chrome.tabs.update(t,{active:!0,highlighted:!0}),await chrome.windows.update(e.windowId,{focused:!0}),!0}catch{return!1}}async function N(t,e){try{return await chrome.tabs.update(t,{url:e}),!0}catch{return!1}}async function $(t){try{await chrome.tabs.remove(t)}catch{}}async function T(){return chrome.tabs.query({url:"*://*.zendesk.com/agent/*"})}const Q=/^\/agent\/(?!chat|voice)(.*)$/,R=/^\/(?:agent\/tickets|tickets|twickets|requests|hc\/requests)\/(.*)$/,M=/^\/(agent\/(chat|talk|admin\/voice)|tickets\/\d+\/print)/,d=".zendesk.com";function f(t){let e;try{e=new URL(t)}catch{return null}if(!e.hostname.endsWith(d))return null;const a=e.hostname.slice(0,-d.length);if(!a)return null;const n=e.pathname;if(M.test(n))return null;const o=n.match(R);if(o){const c=o[1]?.replace("#/","")??"";return{subdomain:a,path:`/tickets/${c}`,type:"ticket"}}const r=n.match(Q);if(r){const c=r[1]?.replace("#/","")??"";return{subdomain:a,path:`/${c}`,type:"lotus"}}return null}function C(t){return`https://${t.subdomain}${d}/agent${t.path}`}function w(t){try{const e=new URL(t);return e.hostname.endsWith(d)&&e.pathname.startsWith("/agent")}catch{return!1}}const b=new Map,y=1e3,g=new Map,U=2e3;function v(t,e){const a=`${t}:${e}`,n=Date.now();for(const[r,c]of b.entries())n-c>y&&b.delete(r);const o=b.get(a);return o&&n-o<y?!0:(b.set(a,n),!1)}async function D(t){const e=t!=="noUrls"?"/images/icons/icon38-enabled.png":"/images/icons/icon38-disabled.png",a=await T();for(const n of a)if(n.id)try{await chrome.action.setIcon({tabId:n.id,path:e})}catch{}}async function O(t,e,a){const n=`*://${t}.zendesk.com/agent/*`,o=await chrome.tabs.query({url:n});if(o.length===0)return null;let r=null,c=0;for(const s of o){if(!s.id||s.id===e||!s.url||!w(s.url))continue;const I=a[s.id]?.lastActive??0;(I>c||r===null)&&(c=I,r=s)}return r}async function A(t,e,a){const n=await h(),o=await O(a.subdomain,t,n.zendeskTabs);if(o?.id){const r=C(a);g.set(o.id,Date.now()),await N(o.id,r)&&(await _(o.id),await $(t),n.zendeskTabs[o.id]={subdomain:a.subdomain,lastActive:Date.now()},delete n.zendeskTabs[t],await i(n))}else n.zendeskTabs[t]={subdomain:a.subdomain,lastActive:Date.now()},await i(n)}async function P(t,e){const a=await h(),n=f(e);if(!n){try{const r=new URL(e).hostname.replace(".zendesk.com","");r&&w(e)&&(a.zendeskTabs[t]={subdomain:r,lastActive:Date.now()},await i(a))}catch{}return}a.zendeskTabs[t]={subdomain:n.subdomain,lastActive:Date.now()},await i(a)}const q=E(()=>{console.log("QuickTab service worker started",{id:S.runtime.id}),chrome.runtime.onInstalled.addListener(async t=>{if(t.reason==="install"){const a=chrome.runtime.getURL("welcome.html");await chrome.tabs.create({url:a})}t.reason==="update"&&(await L(),console.log("QuickTab: Extension updated - state reset"));const e=await T();if(e.length>0){const a=await h();for(const n of e)if(n.id&&n.url){const o=f(n.url);if(o)a.zendeskTabs[n.id]={subdomain:o.subdomain,lastActive:Date.now()};else if(w(n.url))try{const c=new URL(n.url).hostname.replace(".zendesk.com","");a.zendeskTabs[n.id]={subdomain:c,lastActive:Date.now()}}catch{}}await i(a),console.log("QuickTab: Re-detected",e.length,"Zendesk tabs")}}),chrome.webNavigation.onBeforeNavigate.addListener(async t=>{if(t.frameId!==0)return;console.log("QuickTab onBeforeNavigate:",{url:t.url,tabId:t.tabId});const e=g.get(t.tabId);if(e&&Date.now()-e<U){console.log("QuickTab: Skipping - tab was recently updated by us (cascade prevention)");return}if(v(t.tabId,t.url))return;const a=await l();if(a==="noUrls")return;const n=f(t.url);n&&(a==="ticketUrls"&&n.type!=="ticket"||await A(t.tabId,t.url,n))},{url:[{hostSuffix:"zendesk.com"}]}),chrome.webNavigation.onCommitted.addListener(async t=>{if(t.frameId!==0)return;console.log("QuickTab onCommitted:",{url:t.url,tabId:t.tabId,transitionType:t.transitionType});const e=g.get(t.tabId);if(e&&Date.now()-e<U){console.log("QuickTab: Skipping onCommitted - cascade prevention");return}if(v(t.tabId,t.url))return;const a=await l();if(a==="noUrls")return;const n=f(t.url);n&&(a==="ticketUrls"&&n.type!=="ticket"||await A(t.tabId,t.url,n))},{url:[{hostSuffix:"zendesk.com"}]}),chrome.webNavigation.onDOMContentLoaded.addListener(async t=>{if(t.frameId!==0)return;await P(t.tabId,t.url),chrome.action.enable(t.tabId);const e=await l();await D(e)},{url:[{urlContains:"zendesk.com/agent"}]}),chrome.runtime.onMessage.addListener((t,e,a)=>t.type==="getStatus"?(l().then(n=>{a({mode:n})}).catch(()=>{a({mode:"allUrls"})}),!0):t.type==="setMode"?(z(t.mode).then(()=>D(t.mode)).then(()=>{a(!0)}).catch(()=>{a(!1)}),!0):!1)});function x(){}function m(t,...e){}const F={debug:(...t)=>m(console.debug,...t),log:(...t)=>m(console.log,...t),warn:(...t)=>m(console.warn,...t),error:(...t)=>m(console.error,...t)};let k;try{k=q.main(),k instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(t){throw F.error("The background crashed on startup!"),t}return k})();
