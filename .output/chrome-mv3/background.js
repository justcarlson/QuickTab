var background=(function(){"use strict";function I(t){return t==null||typeof t=="function"?{main:t}:t}const z=globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome,u="quicktab_state",k={zendeskTabs:{}};async function b(){try{return(await chrome.storage.local.get(u))[u]??k}catch(t){return console.warn("QuickTab: Storage read failed, using default state",t),k}}async function i(t){try{await chrome.storage.local.set({[u]:t})}catch(e){console.warn("QuickTab: Storage write failed",e)}}async function l(){try{return(await chrome.storage.local.get("urlDetection")).urlDetection??"allUrls"}catch(t){return console.warn("QuickTab: Failed to read URL detection mode",t),"allUrls"}}async function A(t){try{await chrome.storage.local.set({urlDetection:t})}catch(e){console.warn("QuickTab: Failed to write URL detection mode",e)}}async function E(){try{await chrome.storage.local.remove(u)}catch(t){console.warn("QuickTab: Failed to clear state",t)}}async function L(t){try{const e=await chrome.tabs.get(t);return await chrome.tabs.update(t,{active:!0,highlighted:!0}),await chrome.windows.update(e.windowId,{focused:!0}),!0}catch{return!1}}async function S(t,e){try{return await chrome.tabs.update(t,{url:e}),!0}catch{return!1}}async function $(t){try{await chrome.tabs.remove(t)}catch{}}async function T(){return chrome.tabs.query({url:"*://*.zendesk.com/agent/*"})}const N=/^\/agent\/(?!chat|voice)(.*)$/,_=/^\/(?:agent\/tickets|tickets|twickets|requests|hc\/requests)\/(.*)$/,R=/^\/(agent\/(chat|talk|admin\/voice)|tickets\/\d+\/print)/,d=".zendesk.com";function f(t){let e;try{e=new URL(t)}catch{return null}if(!e.hostname.endsWith(d))return null;const n=e.hostname.slice(0,-d.length);if(!n)return null;const a=e.pathname;if(R.test(a))return null;const r=a.match(_);if(r){const c=r[1]?.replace("#/","")??"";return{subdomain:n,path:`/tickets/${c}`,type:"ticket"}}const o=a.match(N);if(o){const c=o[1]?.replace("#/","")??"";return{subdomain:n,path:`/${c}`,type:"lotus"}}return null}function Q(t){return`https://${t.subdomain}${d}/agent${t.path}`}function w(t){try{const e=new URL(t);return e.hostname.endsWith(d)&&e.pathname.startsWith("/agent")}catch{return!1}}const h=new Map,y=1e3;function p(t,e){const n=`${t}:${e}`,a=Date.now();for(const[o,c]of h.entries())a-c>y&&h.delete(o);const r=h.get(n);return r&&a-r<y?!0:(h.set(n,a),!1)}async function U(t){const e=t!=="noUrls"?"/images/icons/icon38-enabled.png":"/images/icons/icon38-disabled.png",n=await T();for(const a of n)if(a.id)try{await chrome.action.setIcon({tabId:a.id,path:e})}catch{}}async function M(t,e,n){const a=`*://${t}.zendesk.com/agent/*`,r=await chrome.tabs.query({url:a});if(r.length===0)return null;let o=null,c=0;for(const s of r){if(!s.id||s.id===e||!s.url||!w(s.url))continue;const D=n[s.id]?.lastActive??0;(D>c||o===null)&&(c=D,o=s)}return o}async function v(t,e,n){const a=await b(),r=await M(n.subdomain,t,a.zendeskTabs);if(r?.id){const o=Q(n);await S(r.id,o)&&(await L(r.id),await $(t),a.zendeskTabs[r.id]={subdomain:n.subdomain,lastActive:Date.now()},delete a.zendeskTabs[t],await i(a))}else a.zendeskTabs[t]={subdomain:n.subdomain,lastActive:Date.now()},await i(a)}async function O(t,e){const n=await b(),a=f(e);if(!a){try{const o=new URL(e).hostname.replace(".zendesk.com","");o&&w(e)&&(n.zendeskTabs[t]={subdomain:o,lastActive:Date.now()},await i(n))}catch{}return}n.zendeskTabs[t]={subdomain:a.subdomain,lastActive:Date.now()},await i(n)}const q=I(()=>{console.log("QuickTab service worker started",{id:z.runtime.id}),chrome.runtime.onInstalled.addListener(async t=>{if(t.reason==="install"){const n=chrome.runtime.getURL("welcome.html");await chrome.tabs.create({url:n})}t.reason==="update"&&(await E(),console.log("QuickTab: Extension updated - state reset"));const e=await T();if(e.length>0){const n=await b();for(const a of e)if(a.id&&a.url){const r=f(a.url);if(r)n.zendeskTabs[a.id]={subdomain:r.subdomain,lastActive:Date.now()};else if(w(a.url))try{const c=new URL(a.url).hostname.replace(".zendesk.com","");n.zendeskTabs[a.id]={subdomain:c,lastActive:Date.now()}}catch{}}await i(n),console.log("QuickTab: Re-detected",e.length,"Zendesk tabs")}}),chrome.webNavigation.onBeforeNavigate.addListener(async t=>{if(t.frameId!==0||(console.log("QuickTab onBeforeNavigate:",{url:t.url,tabId:t.tabId}),p(t.tabId,t.url)))return;const e=await l();if(e==="noUrls")return;const n=f(t.url);n&&(e==="ticketUrls"&&n.type!=="ticket"||await v(t.tabId,t.url,n))},{url:[{hostSuffix:"zendesk.com"}]}),chrome.webNavigation.onCommitted.addListener(async t=>{if(t.frameId!==0||(console.log("QuickTab onCommitted:",{url:t.url,tabId:t.tabId,transitionType:t.transitionType}),p(t.tabId,t.url)))return;const e=await l();if(e==="noUrls")return;const n=f(t.url);n&&(e==="ticketUrls"&&n.type!=="ticket"||await v(t.tabId,t.url,n))},{url:[{hostSuffix:"zendesk.com"}]}),chrome.webNavigation.onDOMContentLoaded.addListener(async t=>{if(t.frameId!==0)return;await O(t.tabId,t.url),chrome.action.enable(t.tabId);const e=await l();await U(e)},{url:[{urlContains:"zendesk.com/agent"}]}),chrome.runtime.onMessage.addListener((t,e,n)=>t.type==="getStatus"?(l().then(a=>{n({mode:a})}).catch(()=>{n({mode:"allUrls"})}),!0):t.type==="setMode"?(A(t.mode).then(()=>U(t.mode)).then(()=>{n(!0)}).catch(()=>{n(!1)}),!0):!1)});function Z(){}function m(t,...e){}const C={debug:(...t)=>m(console.debug,...t),log:(...t)=>m(console.log,...t),warn:(...t)=>m(console.warn,...t),error:(...t)=>m(console.error,...t)};let g;try{g=q.main(),g instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(t){throw C.error("The background crashed on startup!"),t}return g})();
